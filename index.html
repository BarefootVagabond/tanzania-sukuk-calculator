<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tanzania Sukuk Calculator</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1223; --card:#111827; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
    --btn:#1e2636; --btn-hover:#283145; --btn-text:#e5e7eb;
    --accentA:#38bdf8; --accentB:#22c55e;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0b1223,#0f172a);color:var(--ink)}
  header{position:sticky;top:0;background:rgba(11,18,35,.9);backdrop-filter:blur(8px);border-bottom:1px solid #172038;z-index:10}
  .wrap{max-width:1400px;margin:auto;padding:16px}
  .layout{display:grid;grid-template-columns:0.8fr 1.2fr;gap:16px;margin-top:16px}
  @media (max-width:1280px){.layout{grid-template-columns:1fr 1fr}}
  @media (max-width:1000px){.layout{grid-template-columns:1fr}}

  h1{margin:0;font-size:1.25rem;display:flex;gap:10px;align-items:center}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .card .pad{padding:18px}
  label{font-size:.9rem;color:var(--muted)}
  input,select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--ink);outline:none}
  input:focus,select:focus{border-color:transparent;box-shadow:0 0 0 2px rgba(56,189,248,.35),0 0 0 4px rgba(34,197,94,.15)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .hint{color:var(--muted);font-size:.9rem}
  .btns{display:flex;flex-wrap:wrap;gap:8px}
  button{border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700;background:var(--btn);color:var(--btn-text);border:1px solid var(--border)}
  button:hover{background:var(--btn-hover)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #1f2937;padding:8px 6px;text-align:right;white-space:nowrap;font-size:.95rem}
  th:nth-child(1),td:nth-child(1){text-align:left}
  tfoot td{font-weight:700}
  .stat{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kpi{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
  .kpi b{display:block;font-size:1.2rem;margin-top:4px}
  footer{color:#6b7280;text-align:center;padding:18px}
  canvas{width:100%;height:300px;display:block;background:#0b1223;border:1px solid #1f2937;border-radius:12px}
  .section-title{display:flex;justify-content:space-between;align-items:center;margin:14px 0 8px}
  #tblWrap{overflow:auto;max-height:360px;border:1px solid #1f2937;border-radius:12px;margin-top:6px}

  /* Left panel accents */
  .inputs-card{position:relative}
  .inputs-card::before{content:"";position:absolute;left:0;top:0;bottom:0;width:4px;background:linear-gradient(180deg,var(--accentA),var(--accentB))}
  .inputs-header{
    display:inline-flex;align-items:center;gap:8px;
    background:linear-gradient(90deg,rgba(56,189,248,.18),rgba(34,197,94,.18));
    border:1px solid rgba(56,189,248,.25);
    padding:6px 10px;border-radius:999px;font-size:.85rem;margin-bottom:10px;color:#cfefff;
  }

  /* Mobile */
  @media (max-width:720px){
    .row,.row3{grid-template-columns:1fr}
    .btns button{flex:1}
    .stat{grid-template-columns:1fr}
    canvas{height:220px}
    th,td{font-size:.9rem}
  }

  /* collapsible sections */
  details{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin-top:10px}
  details>summary{cursor:pointer;list-style:none;color:var(--ink);font-weight:700;display:flex;gap:10px;align-items:center}
  details>summary::-webkit-details-marker{display:none}

  /* FX panel in results */
  .fxgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:720px){.fxgrid{grid-template-columns:1fr}}
  .fxbox{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
  .fxbox small{color:var(--muted)}
  .fxbox b{display:block;margin-top:4px;font-size:1.05rem}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üìà Tanzania Sukuk Calculator</h1>
    <div class="hint">Calculate <b>profit</b> ‚Ä¢ Simple & Compound ‚Ä¢ Custom tenure & period ‚Ä¢ Dual chart ‚Ä¢ Annual Zakat ‚Ä¢ FX conversion in both currencies.</div>
  </div>
</header>

<div class="wrap layout">
  <!-- Inputs -->
  <section class="card inputs-card">
    <div class="pad">
      <div class="inputs-header">‚öôÔ∏è Inputs</div>

      <div class="row">
        <div>
          <label>Principal Currency</label>
          <select id="principalCurrency">
            <option value="TZS" selected>TZS (Tanzanian Shilling)</option>
            <option value="USD">USD (US Dollar)</option>
          </select>
        </div>
        <div>
          <label>Principal Amount</label>
          <input id="principal" type="number" min="0" step="0.01" placeholder="e.g., 20000000">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Profit rate (per annum, %)</label>
          <input id="rate" type="number" min="0" max="100" step="0.01" placeholder="e.g., 12">
        </div>
        <div>
          <label>Profit Type for Schedule</label>
          <select id="profitType">
            <option value="simple">Simple (paid out, not reinvested)</option>
            <option value="compound" selected>Compound (reinvested)</option>
          </select>
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Tenure Value</label>
          <input id="tenureValue" type="number" min="1" step="1" placeholder="e.g., 5">
        </div>
        <div>
          <label>Tenure Unit</label>
          <select id="tenureUnit">
            <option value="years" selected>Years</option>
            <option value="months">Months</option>
          </select>
        </div>
        <div>
          <label>Payment / Compounding Period</label>
          <select id="period">
            <option value="annual">Annual</option>
            <option value="semi">Semiannual (2√ó/yr)</option>
            <option value="quarterly" selected>Quarterly (4√ó/yr)</option>
            <option value="monthly">Monthly (12√ó/yr)</option>
            <option value="maturity">At Maturity (no interim payouts)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Display Currency</label>
          <select id="displayCurrency">
            <option value="TZS">TZS</option>
            <option value="USD" selected>USD</option>
          </select>
        </div>
        <div>
          <label>FX: 1 USD = <span id="fxLabel">TZS</span></label>
          <input id="fx" type="number" min="0" step="0.0001" placeholder="e.g., 2600">
        </div>
      </div>

      <div class="btns" style="margin-top:12px">
        <button id="calc">Calculate</button>
        <button id="clear">Clear</button>
      </div>

      <div class="hint" style="margin-top:10px">
        Notes:
        <ul>
          <li><b>Simple</b> profit pays out each period and is <i>not</i> reinvested.</li>
          <li><b>Compound</b> assumes reinvestment each period (except ‚ÄúAt Maturity‚Äù, which compounds annually).</li>
          <li>The <b>schedule</b> follows the selected ‚ÄúProfit Type‚Äù, but the <b>chart</b> always shows both methods.</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Outputs -->
  <section class="card">
    <div class="pad">
      <div class="stat">
        <div class="kpi">
          <span>Total Value at End</span>
          <b id="kpiFV">‚Äî</b>
        </div>
        <div class="kpi">
          <span>Total Profit</span>
          <b id="kpiProfit">‚Äî</b>
        </div>
      </div>

      <div style="margin-top:14px" class="row">
        <div class="kpi">
          <span>Effective Periodic Rate</span>
          <b id="kpiPer">‚Äî</b>
        </div>
        <div class="kpi">
          <span>Number of Periods</span>
          <b id="kpiN">‚Äî</b>
        </div>
      </div>

      <!-- FX equivalents panel -->
      <div class="section-title" style="margin-top:16px">
        <h3 style="margin:0">FX Conversion Summary</h3>
        <div class="hint" id="fxNote">Enter FX above to see both currencies.</div>
      </div>
      <div class="fxgrid">
        <div class="fxbox">
          <small>Base currency (<span id="baseCode">‚Äî</span>)</small>
          <b>Total: <span id="baseTotal">‚Äî</span></b>
          <b>Profit: <span id="baseProfit">‚Äî</span></b>
        </div>
        <div class="fxbox">
          <small>Equivalent (<span id="otherCode">‚Äî</span>)</small>
          <b>Total: <span id="otherTotal">‚Äî</span></b>
          <b>Profit: <span id="otherProfit">‚Äî</span></b>
        </div>
      </div>

      <div class="section-title">
        <h3 style="margin:0">Growth Chart ‚Äî Simple vs Compound</h3>
        <div class="hint">Blue = Compound ‚Ä¢ Orange = Simple</div>
      </div>
      <canvas id="chart" width="900" height="300" aria-label="Growth chart"></canvas>

      <details open>
        <summary>
          Cash-Flow Schedule
          <label style="display:inline-flex;gap:6px;align-items:center;margin-left:auto;font-weight:normal">
            <input type="checkbox" id="showDual" checked>
            <span class="hint">Show both currencies in schedule</span>
          </label>
        </summary>
        <div id="tblWrap">
          <table id="tbl">
            <thead id="tblHead"></thead>
            <tbody id="tblBody"></tbody>
            <tfoot id="tblFoot"></tfoot>
          </table>
          <div class="btns" style="margin-top:8px">
            <button id="download">Download CSV</button>
          </div>
        </div>
      </details>

      <details open>
        <summary>Zakat Calculator (per year)</summary>
        <div class="row3" style="margin-top:8px">
          <div>
            <label>Zakat base</label>
            <select id="zBase">
              <option value="profit" selected>Profit only (annual profit)</option>
              <option value="total">Total value (principal + profit)</option>
            </select>
          </div>
          <div>
            <label>Zakat rate (%)</label>
            <input id="zRate" type="number" min="0" step="0.01" value="2.5">
          </div>
          <div>
            <label>Nisab (optional, in display currency)</label>
            <input id="zNisab" type="number" min="0" step="0.01" placeholder="e.g., 500 USD">
          </div>
        </div>

        <div style="overflow:auto;max-height:300px;border:1px solid #1f2937;border-radius:12px;margin-top:10px">
          <table id="zTbl">
            <thead>
              <tr><th>Year</th><th>Base Amount</th><th>Zakat Due</th><th>Cumulative Zakat</th></tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr><td>Total</td><td id="zBaseSum" style="text-align:right">‚Äî</td><td id="zTotal" style="text-align:right">‚Äî</td><td></td></tr>
            </tfoot>
          </table>
        </div>
      </details>
    </div>
  </section>
</div>

<footer>Educational planning tool ‚Ä¢ Uses the term <b>profit</b> to align with Sukuk terminology.</footer>

<script>
(function(){
  const el = id => document.getElementById(id);

  // Inputs
  const principalCurrency = el('principalCurrency');
  const principal = el('principal');
  const rate = el('rate');
  const profitType = el('profitType');
  const tenureValue = el('tenureValue');
  const tenureUnit = el('tenureUnit');
  const period = el('period');
  const displayCurrency = el('displayCurrency'); // tied to principal during calc
  const fx = el('fx');
  const fxLabel = el('fxLabel');
  const showDual = el('showDual');

  // KPIs
  const kpiFV = el('kpiFV'), kpiProfit = el('kpiProfit'), kpiPer = el('kpiPer'), kpiN = el('kpiN');

  // FX panel
  const baseCode = el('baseCode'), otherCode = el('otherCode');
  const baseTotal = el('baseTotal'), baseProfit = el('baseProfit');
  const otherTotal = el('otherTotal'), otherProfit = el('otherProfit');
  const fxNote = el('fxNote');

  // Schedule table parts
  const tblHead = el('tblHead'), tblBody = el('tblBody'), tblFoot = el('tblFoot');
  const downloadBtn = el('download');

  // Zakat table
  const zBaseSel = el('zBase'), zRateInp = el('zRate'), zNisab = el('zNisab');
  const zBody = document.querySelector('#zTbl tbody'), zBaseSum = el('zBaseSum'), zTotal = el('zTotal');

  // Chart
  const canvas = el('chart'), ctx = canvas.getContext('2d');

  const DEFAULT_FX = 2600; // 1 USD ‚âà 2600 TZS

  /* ===== helpers ===== */
  function fmtCurrency(val, code){
    const opts = { style:'currency', currency: code, minimumFractionDigits:(code==='TZS'?0:2), maximumFractionDigits:(code==='TZS'?0:2) };
    try{ return new Intl.NumberFormat('en', opts).format(val); }
    catch{ const nf = new Intl.NumberFormat('en',{ minimumFractionDigits:(code==='TZS'?0:2), maximumFractionDigits:(code==='TZS'?0:2)}); return (code==='TZS'?'TZS ':'$') + nf.format(val); }
  }
  function convert(amount, from, to, fxRate){
    if(from===to) return amount;
    if(!fxRate || fxRate<=0) return amount;
    if(from==='USD' && to==='TZS') return amount * fxRate;
    if(from==='TZS' && to==='USD') return amount / fxRate;
    return amount;
  }
  function freqFromPeriod(p){ return p==='monthly'?12 : p==='quarterly'?4 : p==='semi'?2 : p==='annual'?1 : 0; }
  function periodsTotal(tVal, unit, freq){
    const years = unit==='years' ? tVal : (tVal/12);
    const n = freq===0 ? (unit==='years' ? Math.round(tVal) : Math.round(tVal/12)) : Math.round(years*freq);
    return { years, n };
  }

  /* ===== URL share state ===== */
  const PARAM_KEYS = ['principalCurrency','principal','rate','profitType','tenureValue','tenureUnit','period','displayCurrency','fx','zBase','zRate','zNisab','showDual'];
  function getState(){return{
    principalCurrency:principalCurrency.value, principal:principal.value, rate:rate.value, profitType:profitType.value,
    tenureValue:tenureValue.value, tenureUnit:tenureUnit.value, period:period.value,
    displayCurrency:displayCurrency.value, fx:fx.value, zBase:zBaseSel.value, zRate:zRateInp.value, zNisab:zNisab.value,
    showDual: showDual.checked ? '1' : '0'
  }}
  function setStateFromURL(){
    const q=new URLSearchParams(location.search); if(!q||[...q.keys()].length===0) return false;
    const map={principalCurrency,principal,rate,profitType,tenureValue,tenureUnit,period,displayCurrency,fx,zBase:zBaseSel,zRate:zRateInp,zNisab};
    PARAM_KEYS.forEach(k=>{const v=q.get(k); if(v!==null){ if(k==='showDual'){ showDual.checked=(v==='1'); } else if(map[k]) map[k].value=v; }});
    return true;
  }
  function pushURL(){const s=getState(); const q=new URLSearchParams(); PARAM_KEYS.forEach(k=>{ if(s[k]!==''&&s[k]!==undefined) q.set(k,s[k]); }); history.replaceState(null,'',`${location.pathname}?${q.toString()}`);}
  let urlTimer=null; function onAnyInputChange(){clearTimeout(urlTimer); urlTimer=setTimeout(pushURL,250);}
  [principalCurrency, principal, rate, profitType, tenureValue, tenureUnit, period, displayCurrency, fx, zBaseSel, zRateInp, zNisab, showDual].forEach(c=>c.addEventListener('input', onAnyInputChange));

  /* ===== chart ===== */
  function simulatePaths(P, rY, years, freq){
    const per=(freq? rY/freq : rY);
    if(freq===0){ const steps=Math.round(years), comp=[ ], simp=[ ];
      for(let i=0;i<=steps;i++){ comp.push(P*Math.pow(1+rY,i)); simp.push(P+P*rY*i); }
      return {comp,simp};
    }
    const n=Math.round(years*freq), comp=[P], simp=[P]; let bal=P, simpleCum=0;
    for(let i=1;i<=n;i++){ bal*=1+per; comp.push(bal); simpleCum+=P*per; simp.push(P+simpleCum); }
    return {comp,simp};
  }
  function drawChart(valuesComp, valuesSimp, curr){
    const w=canvas.width,h=canvas.height; const padL=70,padR=16,padT=16,padB=32;
    ctx.clearRect(0,0,w,h);
    const plotW=w-padL-padR, plotH=h-padT-padB;
    ctx.strokeStyle='#23304a'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(padL,padT); ctx.lineTo(padL,padT+plotH); ctx.lineTo(padL+plotW,padT+plotH); ctx.stroke();
    if(valuesComp.length===0||valuesSimp.length===0) return;
    const all=valuesComp.concat(valuesSimp), minV=Math.min(...all), maxV=Math.max(...all);
    const yMin=minV*0.98, yMax=maxV*1.02;
    ctx.strokeStyle='#1b2640'; ctx.setLineDash([3,4]);
    for(let i=1;i<=4;i++){const y=padT+plotH-(plotH*i/4); ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+plotW,y); ctx.stroke();}
    ctx.setLineDash([]);
    ctx.fillStyle='#94a3b8'; ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial';
    [yMin,(yMin+yMax)/2,yMax].forEach(v=>{const y=padT+plotH-(plotH*(v-yMin)/(yMax-yMin)); ctx.fillText(fmtCurrency(v,curr),8,y+4);});
    function line(vals,color){ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
      vals.forEach((v,i)=>{const x=padL+plotW*(i/(vals.length-1||1)); const y=padT+plotH-(plotH*(v-yMin)/(yMax-yMin)); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);});
      ctx.stroke();}
    line(valuesComp,'#38bdf8'); line(valuesSimp,'#f59e0b');
    ctx.fillStyle='#e5e7eb'; ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,Arial';
    ctx.fillText('Compound',padL+6,padT+14); ctx.fillStyle='#94a3b8'; ctx.fillRect(padL-4,padT+8,4,2);
    ctx.fillStyle='#e5e7eb'; ctx.fillText('Simple',padL+100,padT+14);
  }

  /* ===== schedule rendering ===== */
  function renderSchedule(rows, baseCurr, otherCurr, fxRate, showBoth){
    const headCols = showBoth
      ? `<tr>
           <th>Period</th>
           <th>Profit (payout) [${baseCurr}]</th>
           <th>Profit (payout) [${otherCurr}]</th>
           <th>Reinvested?</th>
           <th>Ending Balance [${baseCurr}]</th>
           <th>Ending Balance [${otherCurr}]</th>
         </tr>`
      : `<tr>
           <th>Period</th>
           <th>Profit (payout) [${baseCurr}]</th>
           <th>Reinvested?</th>
           <th>Ending Balance [${baseCurr}]</th>
         </tr>`;
    tblHead.innerHTML = headCols;

    tblBody.innerHTML = '';
    let totProfitBase = 0;
    rows.forEach(r=>{
      totProfitBase += r.payoutBase;
      if(showBoth){
        const payoutO = convert(r.payoutBase, baseCurr, otherCurr, fxRate);
        const endO = convert(r.endBalBase, baseCurr, otherCurr, fxRate);
        tblBody.insertAdjacentHTML('beforeend',
          `<tr>
            <td>${r.p}</td>
            <td style="text-align:right">${fmtCurrency(r.payoutBase, baseCurr)}</td>
            <td style="text-align:right">${fmtCurrency(payoutO, otherCurr)}</td>
            <td style="text-align:center">${r.reinv?'Yes':'No'}</td>
            <td style="text-align:right">${fmtCurrency(r.endBalBase, baseCurr)}</td>
            <td style="text-align:right">${fmtCurrency(endO, otherCurr)}</td>
          </tr>`
        );
      } else {
        tblBody.insertAdjacentHTML('beforeend',
          `<tr>
            <td>${r.p}</td>
            <td style="text-align:right">${fmtCurrency(r.payoutBase, baseCurr)}</td>
            <td style="text-align:center">${r.reinv?'Yes':'No'}</td>
            <td style="text-align:right">${fmtCurrency(r.endBalBase, baseCurr)}</td>
          </tr>`
        );
      }
    });

    // footer
    const totEndBase = rows.length ? rows[rows.length-1].endBalBase : 0;
    if(showBoth){
      const totProfitO = convert(totProfitBase, baseCurr, otherCurr, fxRate);
      const totEndO = convert(totEndBase, baseCurr, otherCurr, fxRate);
      tblFoot.innerHTML =
        `<tr>
          <td>Total</td>
          <td style="text-align:right">${fmtCurrency(totProfitBase, baseCurr)}</td>
          <td style="text-align:right">${fmtCurrency(totProfitO, otherCurr)}</td>
          <td></td>
          <td style="text-align:right">${fmtCurrency(totEndBase, baseCurr)}</td>
          <td style="text-align:right">${fmtCurrency(totEndO, otherCurr)}</td>
        </tr>`;
    } else {
      tblFoot.innerHTML =
        `<tr>
          <td>Total</td>
          <td style="text-align:right">${fmtCurrency(totProfitBase, baseCurr)}</td>
          <td></td>
          <td style="text-align:right">${fmtCurrency(totEndBase, baseCurr)}</td>
        </tr>`;
    }

    // CSV download (respect toggle)
    downloadBtn.onclick = ()=>{
      const lines = [];
      if(showBoth){
        lines.push(['Period',`Profit [${baseCurr}]`,`Profit [${otherCurr}]`,'Reinvested?',`End [${baseCurr}]`,`End [${otherCurr}]`].join(','));
        rows.forEach(r=>{
          const payoutO = convert(r.payoutBase, baseCurr, otherCurr, fxRate);
          const endO = convert(r.endBalBase, baseCurr, otherCurr, fxRate);
          lines.push([r.p, r.payoutBase.toFixed(2), payoutO.toFixed(2), r.reinv?'Yes':'No', r.endBalBase.toFixed(2), endO.toFixed(2)].join(','));
        });
      } else {
        lines.push(['Period',`Profit [${baseCurr}]`,'Reinvested?',`End [${baseCurr}]`].join(','));
        rows.forEach(r=>{
          lines.push([r.p, r.payoutBase.toFixed(2), r.reinv?'Yes':'No', r.endBalBase.toFixed(2)].join(','));
        });
      }
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`tanzania_sukuk_schedule_${Date.now()}.csv`; a.click();
      URL.revokeObjectURL(url);
    };
  }

  /* ===== Zakat ===== */
  function yearlyTotals(P, rY, years){ const out=[]; for(let y=1;y<=years;y++){ out.push({ y, compound:P*Math.pow(1+rY,y) }); } return out; }
  function renderZakat(P, rY, yearsInt, dispCurr, baseMode, zRate, nisab){
    const totals=yearlyTotals(P,rY,yearsInt);
    zBody.innerHTML=''; let cum=0, baseSum=0;
    totals.forEach(t=>{
      const profitThisYear = (P*Math.pow(1+rY,t.y)) - (P*Math.pow(1+rY,t.y-1));
      const baseAmount = (baseMode==='profit') ? profitThisYear : t.compound;
      const zakatDue = (nisab && baseAmount<nisab) ? 0 : baseAmount * zRate;
      cum += zakatDue; baseSum += baseAmount;
      zBody.insertAdjacentHTML('beforeend',
        `<tr><td>Year ${t.y}</td><td style="text-align:right">${fmtCurrency(baseAmount, dispCurr)}</td><td style="text-align:right">${fmtCurrency(zakatDue, dispCurr)}</td><td style="text-align:right">${fmtCurrency(cum, dispCurr)}</td></tr>`
      );
    });
    zBaseSum.textContent = fmtCurrency(baseSum, dispCurr);
    zTotal.textContent = fmtCurrency(cum, dispCurr);
  }

  /* ===== main calc ===== */
  function calculate(){
    const P=Number(principal.value), rY=Number(rate.value)/100, tVal=Number(tenureValue.value);
    const fxRate=Number(fx.value)||DEFAULT_FX;
    const freq=freqFromPeriod(period.value);
    if(!(P>0 && rY>=0 && tVal>0)){ alert('Please enter principal, profit rate, and tenure.'); return; }

    // Sync display currency with principal for consistency
    displayCurrency.value = principalCurrency.value;

    const {years,n}=periodsTotal(tVal,tenureUnit.value,freq);

    // Build schedule (depending on chosen schedule type)
    let rows=[], endBalance=P, totalPayout=0, totalValueBase, totalProfitBase, perRateForKpi, numPeriodsKpi;
    if(profitType.value==='simple'){
      const perRate=(period.value==='maturity' ? rY*years : rY/(freq||1));
      const periods=(period.value==='maturity' ? 1 : n);
      for(let i=1;i<=periods;i++){
        const payout=(period.value==='maturity') ? P*rY*years : P*(rY/freq);
        totalPayout += payout;
        rows.push({p:i, reinv:false, payoutBase:payout, endBalBase:P});
      }
      totalValueBase = P + totalPayout;
      totalProfitBase = totalPayout;
      perRateForKpi=(period.value==='maturity') ? `${(rY*100).toFixed(2)}% / year (single payout at end)` : `${(rY/freq*100).toFixed(4)}% per period`;
      numPeriodsKpi=(period.value==='maturity') ? '1 (at maturity)' : String(n);
    } else {
      const compoundFreq=(period.value==='maturity') ? 1 : freq;
      const periods=(period.value==='maturity') ? Math.round(years) : n;
      const perRate=rY/compoundFreq;
      for(let i=1;i<=periods;i++){
        const profit=endBalance*perRate;
        endBalance += profit;
        rows.push({p:i, reinv:true, payoutBase:profit, endBalBase:endBalance});
      }
      totalValueBase = endBalance;
      totalProfitBase = endBalance - P;
      perRateForKpi = `${(perRate*100).toFixed(4)}% per period`;
      numPeriodsKpi = String(periods);
    }

    // KPIs in base currency
    const baseCurr = principalCurrency.value;
    kpiPer.textContent = perRateForKpi; kpiN.textContent = numPeriodsKpi;
    kpiFV.textContent = fmtCurrency(totalValueBase, baseCurr);
    kpiProfit.textContent = fmtCurrency(totalProfitBase, baseCurr);

    // FX panel (both currencies)
    const otherCurr = (baseCurr==='USD') ? 'TZS' : 'USD';
    baseCode.textContent = baseCurr; otherCode.textContent = otherCurr;
    baseTotal.textContent  = fmtCurrency(totalValueBase, baseCurr);
    baseProfit.textContent = fmtCurrency(totalProfitBase, baseCurr);
    otherTotal.textContent = fmtCurrency(convert(totalValueBase, baseCurr, otherCurr, fxRate), otherCurr);
    otherProfit.textContent= fmtCurrency(convert(totalProfitBase, baseCurr, otherCurr, fxRate), otherCurr);
    fxNote.textContent = `Using your FX: 1 USD = ${fxRate.toLocaleString()} TZS`;

    // Schedule table (dual or single)
    renderSchedule(rows, baseCurr, otherCurr, fxRate, showDual.checked);

    // Chart: both paths (visual comparison)
    const xFreq=(freq===0?1:freq);
    const path=simulatePaths(P,rY,years,xFreq);
    drawChart(path.comp, path.simp, baseCurr);

    // Zakat per year (base currency)
    renderZakat(P, rY, Math.round(years), baseCurr, zBaseSel.value, Number(zRateInp.value)/100, Number(zNisab.value||0));

    pushURL();
  }

  // Buttons
  el('calc').addEventListener('click', calculate);
  el('clear').addEventListener('click', ()=>{
    principal.value=''; rate.value=''; tenureValue.value='';
    profitType.value='compound'; principalCurrency.value='TZS'; period.value='quarterly';
    displayCurrency.value='TZS'; fx.value=DEFAULT_FX; showDual.checked = true;
    tblHead.innerHTML=''; tblBody.innerHTML=''; tblFoot.innerHTML='';
    [kpiFV,kpiProfit,kpiPer,kpiN,baseTotal,baseProfit,otherTotal,otherProfit, baseCode, otherCode].forEach(x=>x.textContent='‚Äî');
    zBody.innerHTML=''; zBaseSum.textContent='‚Äî'; zTotal.textContent='‚Äî';
    const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
    pushURL();
  });

  // Keep display currency mirrored to principal (prevents confusion)
  principalCurrency.addEventListener('change', ()=>{ displayCurrency.value = principalCurrency.value; });

  // FX label
  fxLabel.textContent='TZS';

  // Init: defaults or URL
  function setDefaults(){
    principalCurrency.value='TZS';
    principal.value='20000000';
    rate.value='14';
    tenureValue.value='5';
    tenureUnit.value='years';
    period.value='quarterly';
    displayCurrency.value='TZS';
    fx.value=DEFAULT_FX;
    showDual.checked = true;
  }
  if(!setStateFromURL()){ setDefaults(); }

  // Auto-calc if params provided
  if(new URLSearchParams(location.search).toString().length>0){ calculate(); }
})();
</script>
</body>
</html>
